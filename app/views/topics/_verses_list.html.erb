<div id="topic-verses-list">
  <% if grouped_verse_topics.any? %>
    <div class="topic-verses-list">
      <% grouped_verse_topics.each do |group| %>
        <% # Get unique verses from the group %>
        <% unique_verses = group.map { |vt| vt.bible_verse }.uniq %>
        <% first_verse = unique_verses.first %>
        <% last_verse = unique_verses.last %>
        <% is_range = unique_verses.length > 1 %>
        
        <div class="topic-verse-item">
          <div class="topic-verse-header">
            <h3 class="topic-verse-reference">
              <% if is_range %>
                <%= link_to "#{first_verse.book} #{first_verse.chapter}:#{first_verse.verse}-#{last_verse.verse}", 
                    bible_verse_show_path(
                      book: first_verse.book, 
                      chapter: first_verse.chapter, 
                      verse: first_verse.verse
                    ), 
                    class: "verse-link font-semibold" %>
              <% else %>
                <%= link_to first_verse.reference, 
                    bible_verse_show_path(
                      book: first_verse.book, 
                      chapter: first_verse.chapter, 
                      verse: first_verse.verse
                    ), 
                    class: "verse-link font-semibold" %>
              <% end %>
            </h3>
          </div>
          
          <div class="topic-verse-content-wrapper">
            <div class="topic-verse-text">
              <% # Get unique verses from the group (since we may have multiple VerseTopics per verse) %>
              <% unique_verses = group.map { |vt| vt.bible_verse }.uniq %>
              <% unique_verses.each do |verse| %>
                <p class="text-gray-800 italic mb-2">
                  <strong><%= verse.reference %>:</strong> <%= verse.text %>
                </p>
              <% end %>
            </div>
            
            <% explanations = group.select { |vt| vt.explanation.present? } %>
            <% user_verse_topics_without_explanation = group.select { |vt| vt.explanation.blank? && current_user && current_user.can_edit?(vt) } %>
            
            <% if explanations.any? || user_verse_topics_without_explanation.any? %>
              <div class="topic-verse-explanation">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Connection to Topic:</h4>
                
                <% if explanations.any? %>
                  <% explanations.each_with_index do |verse_topic, index| %>
                    <div class="explanation-item <%= 'mt-3 pt-3 border-t border-gray-200' unless index == 0 %>">
                      <div class="d-flex justify-between items-start">
                        <div class="flex-1">
                          <p class="text-sm text-gray-700 mb-0">
                            <span class="font-semibold">v<%= verse_topic.bible_verse.verse %>:</span> <%= verse_topic.explanation.to_plain_text.strip.gsub(/\n/, ' ') %>
                          </p>
                          <div class="explanation-meta text-xs text-gray-500 mt-2">
                            — <%= verse_topic.user.display_name %> • <%= time_ago_in_words(verse_topic.created_at) %> ago
                          </div>
                        </div>
                        <% if current_user && current_user.can_edit?(verse_topic) %>
                          <div class="explanation-actions ml-3 d-flex gap-2">
                            <%= link_to edit_verse_topic_path(verse_topic, topic_id: local_assigns[:topic]&.id), 
                                class: "btn btn-sm btn-outline", 
                                data: { turbo_frame: "modal" },
                                title: "Edit explanation" do %>
                              <i class="fa-solid fa-edit"></i>
                            <% end %>
                            <%= button_to verse_topic_path(verse_topic, topic_id: local_assigns[:topic]&.id), 
                                method: :delete, 
                                class: "btn btn-sm btn-danger",
                                data: { 
                                  turbo: true,
                                  confirm: "Are you sure you want to delete this explanation?" 
                                },
                                title: "Delete explanation",
                                form: { data: { turbo_frame: "_top" } } do %>
                              <i class="fa-solid fa-trash"></i>
                            <% end %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                <% end %>
                
                <% if user_verse_topics_without_explanation.any? %>
                  <% user_verse_topics_without_explanation.each_with_index do |verse_topic, index| %>
                    <div class="explanation-item <%= 'mt-3 pt-3 border-t border-gray-200' unless explanations.empty? && index == 0 %>">
                      <div class="d-flex justify-between items-start">
                        <div class="flex-1">
                          <p class="text-sm text-gray-500 italic mb-0">
                            <span class="font-semibold">v<%= verse_topic.bible_verse.verse %>:</span> No explanation added yet
                          </p>
                          <div class="explanation-meta text-xs text-gray-500 mt-2">
                            — You added this verse • <%= time_ago_in_words(verse_topic.created_at) %> ago
                          </div>
                        </div>
                        <div class="explanation-actions ml-3">
                          <%= link_to edit_verse_topic_path(verse_topic, topic_id: local_assigns[:topic]&.id), 
                              class: "btn btn-sm btn-primary", 
                              data: { turbo_frame: "modal" },
                              title: "Add explanation" do %>
                            <i class="fa-solid fa-plus"></i> Add Explanation
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="text-center py-8 text-gray-500">
      <p>No verses have been added to this topic yet.</p>
    </div>
  <% end %>
</div>
