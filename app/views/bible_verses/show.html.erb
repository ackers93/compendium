<div class="page-header">
  <h1 class="page-title"><%= @book %> <%= @chapter %>:<%= @verse %></h1>
  <p class="page-subtitle">King James Version</p>
</div>

<div class="content-section">
  <div class="verse-display">
    <div class="verse-header">
      <div class="verse-reference">
        <%= @book %> <%= @chapter %>:<%= @verse %>
      </div>
      <div class="verse-navigation">
        <% if @verse > 1 %>
          <%= link_to "← Previous Verse", bible_verse_show_path(book: @book, chapter: @chapter, verse: @verse - 1), 
              class: "nav-button" %>
        <% end %>
        
        <%= link_to "Chapter", bible_verse_verses_path(book: @book, chapter: @chapter), 
            class: "nav-button" %>
        
        <% next_verse = BibleVerse.find_by(book: @book, chapter: @chapter, verse: @verse + 1) %>
        <% if next_verse %>
          <%= link_to "Next Verse →", bible_verse_show_path(book: @book, chapter: @chapter, verse: @verse + 1), 
              class: "nav-button" %>
        <% end %>
      </div>
    </div>
    
    <div class="verse-content">
      <%= @bible_verse.text %>
    </div>
  </div>
  
  <!-- Tabs Section -->
  <div class="tabs-section mt-8">
    <div class="tabs-header">
      <div class="tabs-nav">
        <button class="tab-button active" onclick="showTab('comments')">Comments</button>
        <button class="tab-button" onclick="showTab('cross-references')">Cross-References</button>
        <button class="tab-button" onclick="showTab('threads')">Threads</button>
        <button class="tab-button" onclick="showTab('topics')">Topics</button>
      </div>
    </div>
    
    <!-- Comments Tab -->
    <div id="comments-tab" class="tab-content active">
      <div class="comments-section">
        <div class="section-header">
          <div class="d-flex justify-between items-center">
            <h3 class="section-title">Comments on <%= @book %> <%= @chapter %>:<%= @verse %></h3>
            <div id="comment-count">
              <%= render 'comments/comment_count', commentable: @bible_verse %>
            </div>
          </div>
        </div>
        
        <div id="comments" class="comments-list mb-6">
          <%= render 'comments/comments_list', commentable: @bible_verse %>
        </div>
        
        <!-- Add Comment Form -->
        <% if current_user&.can_create? %>
          <div class="add-comment-section">
            <h4 class="text-lg font-semibold mb-4">Add a Comment</h4>
            <div id="comment-form">
              <%= render 'comments/form', comment: @bible_verse.comments.build %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    
    <!-- Cross-References Tab -->
    <div id="cross-references-tab" class="tab-content">
      <div class="cross-references-section">
        <div class="section-header">
          <div class="d-flex justify-between items-center">
            <h3 class="section-title">Cross-References for <%= @book %> <%= @chapter %>:<%= @verse %></h3>
            <% if current_user&.can_create? %>
              <button class="btn btn-primary" onclick="showCrossReferenceModal()">
                Add Cross-Reference
              </button>
            <% end %>
          </div>
        </div>
        
        <div id="cross-references" class="cross-references-content mb-6">
          <%= render 'cross_references/cross_references_list', 
              cross_references: @bible_verse.ordered_cross_references, 
              verse: @bible_verse %>
        </div>
      </div>
    </div>
    
    <!-- Threads Tab -->
    <div id="threads-tab" class="tab-content">
      <div class="threads-section">
        <div class="section-header">
          <div class="d-flex justify-between items-center">
            <h3 class="section-title">Threads Containing This Verse</h3>
            <% if current_user&.can_create? %>
              <%= link_to new_bible_thread_path, class: "btn btn-primary" do %>
                <i class="fa-solid fa-plus"></i>
                New Thread
              <% end %>
            <% end %>
          </div>
        </div>
        
        <div id="threads-list" class="threads-content mb-6">
          <% threads = @bible_verse.bible_threads %>
          <% if threads.any? %>
            <div class="threads-list">
              <% threads.each do |thread| %>
                <div class="thread-item">
                  <div class="thread-title-link">
                    <%= link_to thread.title, bible_thread_path(thread), class: "font-semibold text-lg" %>
                  </div>
                  <div class="thread-meta text-sm text-gray-600 mt-1">
                    Created by <%= thread.user.display_name %> • <%= pluralize(thread.bible_thread_entries.count, 'verse') %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-8 text-gray-500">
              <p>This verse is not part of any threads yet.</p>
              <% if current_user&.can_create? %>
                <p class="text-sm mt-2">
                  <%= link_to "Create a thread", new_bible_thread_path, class: "text-blue-600 hover:text-blue-800" %> to connect this verse with others thematically.
                </p>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    
    <!-- Topics Tab -->
    <div id="topics-tab" class="tab-content">
      <div class="topics-section">
        <div class="section-header">
          <div class="d-flex justify-between items-center">
            <h3 class="section-title">Topics for <%= @book %> <%= @chapter %>:<%= @verse %></h3>
            <% if current_user&.can_create? %>
              <%= link_to new_bible_verse_topic_path(book: @book, chapter: @chapter, verse: @verse), 
                  class: "btn btn-primary", 
                  data: { turbo_frame: "modal" } do %>
                <i class="fa-solid fa-plus"></i>
                Add to Topic
              <% end %>
            <% end %>
          </div>
        </div>
        
        <div id="topics-list" class="topics-content mb-6">
          <%= render 'verse_topics/topics_list', bible_verse: @bible_verse %>
        </div>
      </div>
    </div>
  </div>
  
  <div class="d-flex justify-between mt-6">
    <%= link_to "← Back to Chapter", bible_verse_verses_path(book: @book, chapter: @chapter), 
        class: "btn btn-outline" %>
    <%= link_to "← Back to Books", bible_verses_books_path, class: "btn btn-outline" %>
  </div>
</div>

<!-- Cross-Reference Modal -->
<%= turbo_frame_tag "modal" %>

<script>
function showTab(tabName) {
  // Hide all tab contents
  const tabContents = document.querySelectorAll('.tab-content');
  tabContents.forEach(content => content.classList.remove('active'));
  
  // Remove active class from all tab buttons
  const tabButtons = document.querySelectorAll('.tab-button');
  tabButtons.forEach(button => button.classList.remove('active'));
  
  // Show selected tab content
  document.getElementById(tabName + '-tab').classList.add('active');
  
  // Add active class to clicked button
  event.target.classList.add('active');
}

function showCrossReferenceModal() {
  // Use Turbo to load the modal content
  const modalFrame = document.getElementById('modal');
  if (modalFrame) {
    modalFrame.src = '<%= new_bible_verse_cross_reference_path(source_book: @book, source_chapter: @chapter, source_verse: @verse) %>';
  }
}
</script> 