<div class="page-header">
  <h1 class="page-title"><%= @book %> <%= @chapter %></h1>
  <p class="page-subtitle">All verses in this chapter</p>
</div>

<div class="content-section" data-controller="verse-view-toggle">
  <div class="section-header">
    <div class="d-flex justify-between items-center">
      <h2 class="section-title">Chapter <%= @chapter %></h2>
      <div class="d-flex gap-2 items-center">
        <button 
          type="button" 
          class="btn btn-outline btn-sm"
          data-verse-view-toggle-target="toggleButton"
          data-action="click->verse-view-toggle#toggle">
          Switch to List View
        </button>
        <%= link_to "← Back to Chapters", bible_verse_chapters_path(book: @book), class: "btn btn-outline" %>
        <%= link_to "← Back to Books", bible_verses_books_path, class: "btn btn-outline" %>
      </div>
    </div>
  </div>
  
  <div class="section-content">
    <!-- Card View (Table Style) -->
    <div data-verse-view-toggle-target="cardView" class="verses-table-view">
      <% @verses.each do |verse| %>
        <div class="verse-table-row">
          <%= link_to bible_verse_show_path(book: @book, chapter: @chapter, verse: verse.verse), 
              class: "verse-column verse-column-link" do %>
            <span class="verse-number font-bold text-primary"><%= verse.verse %></span>
            <span class="verse-text text-gray-700"><%= verse.text %></span>
          <% end %>
          <div class="verse-content-column">
            <!-- Comments Section -->
            <% if verse.comments.any? %>
              <div class="verse-comments-section mb-3">
                <% verse.comments.order(created_at: :desc).each do |comment| %>
                  <div class="comment-preview" data-comment-id="<%= comment.id %>">
                    <div class="comment-preview-text">
                      <%= plain_text_from_rich_text(comment.content, 40) %>
                    </div>
                    <div class="comment-full-text">
                      <div class="comment-header text-xs text-gray-500 mb-1">
                        <span class="author-name"><%= comment.user&.display_name || "Unknown User" %></span>
                        <span class="comment-date">• <%= time_ago_in_words(comment.created_at) %> ago</span>
                      </div>
                      <div class="comment-content">
                        <%= comment.content %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
            
            <!-- Cross-References Section -->
            <% if verse.ordered_cross_references.any? %>
              <div class="verse-cross-refs-section mb-3">
                <span class="verse-cross-refs-section-title">CRs:</span>
                <% verse.ordered_cross_references.each_with_index do |cross_ref, index| %>
                  <% other_verse = cross_ref.source_verse_id == verse.id ? cross_ref.target_verse : cross_ref.source_verse %>
                  <%= link_to "#{other_verse.book} #{other_verse.chapter}:#{other_verse.verse}", 
                      bible_verse_show_path(book: other_verse.book, chapter: other_verse.chapter, verse: other_verse.verse),
                      class: "cross-ref-link" %><% unless index == verse.ordered_cross_references.count - 1 %>, <% end %>
                <% end %>
              </div>
            <% end %>
            
            <!-- Threads Section -->
            <% if verse.bible_threads.any? %>
              <div class="verse-threads-section">
                <span class="verse-threads-section-title">T:</span>
                <% verse.bible_threads.each_with_index do |thread, index| %>
                  <%= link_to thread.title, bible_thread_path(thread), class: "thread-link" %><% unless index == verse.bible_threads.count - 1 %>, <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- List View (Alternative Style) -->
    <div data-verse-view-toggle-target="listView" class="verses-list-list-view hidden">
      <% @verses.each do |verse| %>
        <%= link_to bible_verse_show_path(book: @book, chapter: @chapter, verse: verse.verse), 
            class: "verse-item-list-link" do %>
          <div class="verse-item-list">
            <div class="d-flex items-center justify-between gap-4">
              <div class="d-flex items-start gap-2 flex-1">
                <span class="verse-number-list font-bold text-primary flex-shrink-0"><%= verse.verse %></span>
                <span class="verse-text-list text-gray-700"><%= verse.text %></span>
              </div>
              <div class="verse-counts-cell flex-shrink-0 text-sm text-gray-500">
                <% counts = [] %>
                <% counts << "C:#{verse.comments.count}" if verse.comments.any? %>
                <% counts << "CR:#{verse.all_cross_references.count}" if verse.all_cross_references.any? %>
                <% counts << "T:#{verse.bible_threads.count}" if verse.bible_threads.any? %>
                <%= counts.join(' | ') if counts.any? %>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div> 