<%= render 'admin/shared/admin_nav' %>

<div class="page-header">
  <h1 class="page-title">Flagged Content Review</h1>
  <p class="page-subtitle">Review and moderate flagged content</p>
</div>

<div class="content-section">
  <!-- Status Statistics Cards -->
  <div class="admin-stats-grid">
    <div class="stat-card stat-card-warning">
      <div class="stat-icon">
        <i class="fa-solid fa-flag"></i>
      </div>
      <div class="stat-content">
        <h3 class="stat-label">Pending Review</h3>
        <p class="stat-number"><%= @pending_count %></p>
        <%= link_to "View All", admin_content_flags_path(status: 'pending'), class: "stat-link" %>
      </div>
    </div>
    
    <div class="stat-card stat-card-success">
      <div class="stat-icon">
        <i class="fa-solid fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <h3 class="stat-label">Approved</h3>
        <p class="stat-number"><%= @approved_count %></p>
        <%= link_to "View All", admin_content_flags_path(status: 'approved'), class: "stat-link" %>
      </div>
    </div>
    
    <div class="stat-card stat-card-info">
      <div class="stat-icon">
        <i class="fa-solid fa-redo"></i>
      </div>
      <div class="stat-content">
        <h3 class="stat-label">Review Requested</h3>
        <p class="stat-number"><%= @review_requested_count %></p>
        <%= link_to "View All", admin_content_flags_path(status: 'review_requested'), class: "stat-link" %>
      </div>
    </div>
    
    <div class="stat-card stat-card-primary">
      <div class="stat-icon">
        <i class="fa-solid fa-edit"></i>
      </div>
      <div class="stat-content">
        <h3 class="stat-label">Edited</h3>
        <p class="stat-number"><%= @edited_count %></p>
        <%= link_to "View All", admin_content_flags_path(status: 'edited'), class: "stat-link" %>
      </div>
    </div>
    
    <div class="stat-card stat-card-danger">
      <div class="stat-icon">
        <i class="fa-solid fa-trash"></i>
      </div>
      <div class="stat-content">
        <h3 class="stat-label">Deleted</h3>
        <p class="stat-number"><%= @deleted_count %></p>
        <%= link_to "View All", admin_content_flags_path(status: 'deleted'), class: "stat-link" %>
      </div>
    </div>
  </div>
</div>

<!-- Filter Tabs -->
<div class="content-section">
  <div class="filter-tabs">
    <%= link_to admin_content_flags_path(status: 'pending'), class: "filter-tab #{(params[:status] == 'pending' || params[:status].blank?) ? 'active' : ''}" do %>
      <i class="fa-solid fa-flag"></i>
      Pending
    <% end %>
    <%= link_to admin_content_flags_path(status: 'approved'), class: "filter-tab #{params[:status] == 'approved' ? 'active' : ''}" do %>
      <i class="fa-solid fa-check-circle"></i>
      Approved
    <% end %>
    <%= link_to admin_content_flags_path(status: 'review_requested'), class: "filter-tab #{params[:status] == 'review_requested' ? 'active' : ''}" do %>
      <i class="fa-solid fa-redo"></i>
      Review Requested
    <% end %>
    <%= link_to admin_content_flags_path(status: 'edited'), class: "filter-tab #{params[:status] == 'edited' ? 'active' : ''}" do %>
      <i class="fa-solid fa-edit"></i>
      Edited
    <% end %>
    <%= link_to admin_content_flags_path(status: 'deleted'), class: "filter-tab #{params[:status] == 'deleted' ? 'active' : ''}" do %>
      <i class="fa-solid fa-trash"></i>
      Deleted
    <% end %>
  </div>
</div>

<!-- Flags Table -->
<div class="content-section">
  <% if @flags.any? %>
    <div class="flags-table-container">
      <% @flags.each do |flag| %>
        <div class="flag-card">
          <div class="flag-header">
            <div class="flag-type">
              <% case flag.flaggable_type %>
              <% when 'Note' %>
                <i class="fa-solid fa-file-lines"></i> Note
              <% when 'Comment' %>
                <i class="fa-solid fa-comment"></i> Comment
              <% when 'CrossReference' %>
                <i class="fa-solid fa-link"></i> Cross-Reference
              <% end %>
            </div>
            <div class="flag-status">
              <span class="badge badge-<%= flag.status %>"><%= flag.status.humanize %></span>
            </div>
          </div>
          
          <div class="flag-content">
            <h3 class="flag-title"><%= flag.flaggable_title %></h3>
            
            <div class="flag-meta">
              <div class="flag-meta-item">
                <strong>Content Author:</strong> 
                <%= flag.content_author.email %>
              </div>
              <div class="flag-meta-item">
                <strong>Flagged By:</strong> 
                <%= flag.user.email %>
              </div>
              <div class="flag-meta-item">
                <strong>Flagged At:</strong> 
                <%= flag.created_at.strftime("%b %d, %Y at %I:%M %p") %>
              </div>
            </div>
            
            <% if flag.reason.present? %>
              <div class="flag-reason">
                <strong>Reason:</strong>
                <p><%= flag.reason %></p>
              </div>
            <% end %>
            
            <div class="flag-preview">
              <strong>Content Preview:</strong>
              <div class="content-preview-box">
                <% case flag.flaggable_type %>
                <% when 'Note' %>
                  <% if flag.flaggable.content.present? %>
                    <%= truncate(flag.flaggable.content.to_plain_text, length: 200) %>
                  <% else %>
                    <em>No content</em>
                  <% end %>
                <% when 'Comment' %>
                  <% if flag.flaggable.content.present? %>
                    <%= truncate(flag.flaggable.content.to_plain_text, length: 200) %>
                  <% else %>
                    <em>No content</em>
                  <% end %>
                <% when 'CrossReference' %>
                  <%= flag.flaggable.source_verse.reference %> â†’ <%= flag.flaggable.target_verse.reference %>
                <% end %>
              </div>
            </div>
            
            <% if flag.resolved? %>
              <div class="flag-resolution">
                <div class="flag-meta">
                  <div class="flag-meta-item">
                    <strong>Resolved By:</strong> 
                    <%= flag.resolved_by&.email || 'N/A' %>
                  </div>
                  <div class="flag-meta-item">
                    <strong>Resolved At:</strong> 
                    <%= flag.resolved_at&.strftime("%b %d, %Y at %I:%M %p") || 'N/A' %>
                  </div>
                </div>
                <% if flag.admin_note.present? %>
                  <div class="flag-reason">
                    <strong>Admin Note:</strong>
                    <p><%= flag.admin_note %></p>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
          
          <% if flag.status_pending? %>
            <div class="flag-actions">
              <% 
                # Determine the correct path based on flaggable type
                view_path = case flag.flaggable_type
                when 'Note'
                  note_path(flag.flaggable)
                when 'Comment'
                  case flag.flaggable.commentable_type
                  when 'Note'
                    note_path(flag.flaggable.commentable)
                  when 'BibleVerse'
                    verse = flag.flaggable.commentable
                    bible_verse_show_path(verse.book, verse.chapter, verse.verse)
                  when 'CrossReference'
                    xref = flag.flaggable.commentable
                    bible_verse_show_path(xref.source_verse.book, xref.source_verse.chapter, xref.source_verse.verse)
                  end
                when 'CrossReference'
                  bible_verse_show_path(flag.flaggable.source_verse.book, flag.flaggable.source_verse.chapter, flag.flaggable.source_verse.verse)
                end
              %>
              <%= link_to "View Content", view_path, class: "btn btn-sm btn-outline", target: "_blank" %>
              
              <%= button_to approve_admin_content_flag_path(flag), 
                  method: :patch, 
                  class: "btn btn-sm btn-success",
                  form: { onsubmit: "return confirm('Are you sure you want to approve this content?')" } do %>
                <i class="fa-solid fa-check"></i> Approve
              <% end %>
              
              <%= button_to request_review_admin_content_flag_path(flag), 
                  method: :patch, 
                  class: "btn btn-sm btn-warning",
                  form: { onsubmit: "const note = prompt('Add a note for the author (optional):'); if(note !== null) { this.querySelector('input[name=admin_note]').value = note; return true; } return false;" } do %>
                <input type="hidden" name="admin_note" value="">
                <i class="fa-solid fa-redo"></i> Request Review
              <% end %>
              
              <%= link_to edit_content_admin_content_flag_path(flag), 
                  class: "btn btn-sm btn-primary" do %>
                <i class="fa-solid fa-edit"></i> Edit Content
              <% end %>
              
              <%= button_to destroy_content_admin_content_flag_path(flag), 
                  method: :delete, 
                  class: "btn btn-sm btn-danger",
                  form: { onsubmit: "const note = prompt('Add a note explaining why this content is being deleted (optional):'); if(note !== null && confirm('Are you sure you want to delete this content? This action cannot be undone.')) { this.querySelector('input[name=admin_note]').value = note; return true; } return false;" } do %>
                <input type="hidden" name="admin_note" value="">
                <i class="fa-solid fa-trash"></i> Delete Content
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="empty-state">
      <i class="fa-solid fa-flag-checkered"></i>
      <p>No flagged content found with this filter.</p>
      <%= link_to "View All Flags", admin_content_flags_path, class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

